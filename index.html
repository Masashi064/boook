<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ã¿ã‚“ãªã®æœ¬ç´¹ä»‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sand: {
              50: '#f7f5f1',
              100: '#efece5',
              200: '#e2ddd4',
              300: '#cfc9bd',
              500: '#958f85',
              700: '#5c564d'
            },
            moss: {
              100: '#dfe6dd',
              400: '#9da98f',
              500: '#6f7b62',
              700: '#4b5542'
            },
            slategreen: '#3a4a3f'
          },
          fontFamily: {
            heading: ['"Hiragino Sans"', '"Yu Gothic"', 'system-ui', 'sans-serif']
          },
          boxShadow: {
            soft: '0 20px 45px rgba(24, 36, 28, 0.12)'
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: "Hiragino Sans", "Yu Gothic", system-ui, -apple-system, "Helvetica Neue", sans-serif;
      background: linear-gradient(160deg, #f4f2ec 0%, #f8f7f4 18%, #ebe1d4 100%);
      color: #1f2933;
    }
    .texture-top {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 15% 20%, rgba(157, 169, 143, 0.18), transparent 55%),
                  radial-gradient(circle at 85% 10%, rgba(206, 192, 173, 0.18), transparent 60%),
                  radial-gradient(circle at 50% 90%, rgba(159, 174, 150, 0.16), transparent 62%);
      pointer-events: none;
      mix-blend-mode: multiply;
      z-index: 0;
    }
    .glass-panel {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 60px rgba(56, 66, 62, 0.15);
      border: 1px solid rgba(215, 215, 211, 0.4);
    }
    .floating-shape {
      position: absolute;
      border-radius: 9999px;
      filter: blur(50px);
      opacity: 0.35;
      animation: float 14s ease-in-out infinite;
      mix-blend-mode: multiply;
    }
    .floating-shape:nth-child(1) { inset: 12% auto auto -14%; width: 260px; height: 260px; background: #dfe6dd; }
    .floating-shape:nth-child(2) { inset: auto -10% 18% auto; width: 320px; height: 320px; background: #e2ddd4; animation-delay: 3s; }
    .floating-shape:nth-child(3) { inset: 70% auto auto 60%; width: 280px; height: 280px; background: #cbdad3; animation-delay: 6s; }
    @keyframes float {
      0%, 100% { transform: translate3d(0, 0, 0) scale(1); }
      50% { transform: translate3d(25px, -30px, 0) scale(1.04); }
    }
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 10px;
      border-radius: 9999px;
      background: rgba(111, 123, 98, 0.12);
      color: #4b5542;
      font-size: 12px;
      font-weight: 500;
    }
    .star { font-size: 18px; line-height: 1; }
    .star.filled { color: #d9983b; }
    .dropdown { position: absolute; z-index: 40; background: white; border: 1px solid #e5e7eb; border-radius: 12px; width: 100%; max-height: 240px; overflow: auto; box-shadow: 0 18px 36px rgba(55, 65, 81, 0.15); }
    .dropdown-item { padding: 10px 14px; cursor: pointer; font-size: 14px; }
    .dropdown-item:hover { background: #f3f4f6; }
    dialog::backdrop { background: rgba(62, 70, 63, 0.45); backdrop-filter: blur(4px); }
    .modal-card { background: #fdfcf9; }
    [data-animate] { opacity: 0; transform: translateY(30px) scale(.98); transition: opacity .8s ease, transform .8s cubic-bezier(.19,1,.22,1); }
    [data-animate].is-visible { opacity: 1; transform: translateY(0) scale(1); }
    .list-card { transition: transform .5s ease, box-shadow .5s ease; border: 1px solid rgba(205, 200, 191, 0.7); }
    .list-card:hover { transform: translateY(-6px); box-shadow: 0 22px 40px rgba(52, 64, 52, 0.18); }
    .list-card::before {
      content: '';
      position: absolute;
      inset: 14px auto 14px 0;
      width: 6px;
      border-radius: 9999px;
      background: linear-gradient(180deg, rgba(111,123,98,0.8), rgba(157,169,143,0.45));
    }
    .badge { padding: 2px 8px; border-radius: 9999px; background: rgba(142, 154, 132, 0.18); font-size: 12px; color: #4b5542; }
    .loader-dot { width: 10px; height: 10px; border-radius: 999px; background: rgba(111, 123, 98, 0.58); animation: pulse 1.2s infinite ease-in-out; }
    .loader-dot:nth-child(2) { animation-delay: .2s; }
    .loader-dot:nth-child(3) { animation-delay: .4s; }
    @keyframes pulse { 0%, 100% { opacity: .3; transform: translateY(0);} 50% { opacity: 1; transform: translateY(-5px);} }
    @media (max-width: 768px), (pointer: coarse) {
      [data-animate]{ opacity:1 !important; transform:none !important; }
    }
  </style>
</head>
<body>
  <div class="relative min-h-screen overflow-hidden">
    <div class="floating-shape"></div>
    <div class="floating-shape"></div>
    <div class="floating-shape"></div>
    <div class="texture-top"></div>

    <div class="relative max-w-6xl mx-auto px-4 sm:px-6 pb-16 pt-10">
      <header class="mb-12 md:mb-16" data-animate>
        <div class="md:grid md:grid-cols-[minmax(0,1.1fr)_minmax(0,340px)] md:gap-10 items-center">
          <div class="space-y-6">
            <span class="inline-flex items-center gap-2 rounded-full bg-moss-100 text-moss-700 px-4 py-1 text-xs font-medium uppercase tracking-[0.2em]">Community Picks</span>
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-heading font-semibold leading-tight text-slategreen drop-shadow-sm">
              ğŸ“š ã¿ã‚“ãªã®æœ¬ç´¹ä»‹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            </h1>
            <p class="text-base sm:text-lg text-sand-700 leading-relaxed">
              æŠ•è³‡ãƒ»ãƒãƒãƒ¼ã«é–¢ã™ã‚‹è‰¯æ›¸ã‚’ãŠæ¢ã—ã®æ–¹ã¸ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§ã®ç™»éŒ²ãƒ»æ¯”è¼ƒã«å¯¾å¿œã—ã€äººæ°—ã®ç†ç”±ã‚„è©•ä¾¡ã‚’é–²è¦§ã§ãã¾ã™ã€‚è‡ªèº«ã®èª²é¡Œã«åˆã†ä¸€å†Šã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ï¼
            </p>
            <dl class="grid sm:grid-cols-3 gap-3 text-sm text-sand-700">
              <div class="glass-panel rounded-2xl px-4 py-3 border border-white/60 shadow-soft">
                <dt class="text-xs uppercase tracking-[0.18em] text-slategreen/70">ã‚·ãƒ³ãƒ—ãƒ«ç™»éŒ²</dt>
                <dd class="mt-1 text-base font-semibold text-slategreen">30ç§’ã§æŠ•ç¨¿å®Œäº†</dd>
              </div>
              <div class="glass-panel rounded-2xl px-4 py-3 border border-white/60 shadow-soft">
                <dt class="text-xs uppercase tracking-[0.18em] text-slategreen/70">ã¿ã‚“ãªã®çŸ¥è¦‹</dt>
                <dd class="mt-1 text-base font-semibold text-slategreen">æ¬¡ã®ä¸€å†ŠãŒè¦‹ã¤ã‹ã‚‹</dd>
              </div>
              <div class="glass-panel rounded-2xl px-4 py-3 border border-white/60 shadow-soft">
                <dt class="text-xs uppercase tracking-[0.18em] text-slategreen/70">ã‚µã‚¯ãƒƒã¨è²¢çŒ®</dt>
                <dd class="mt-1 text-base font-semibold text-slategreen">å°ã•ãªæŠ•ç¨¿ãŒå¤§ããªåŠ©ã‘ã«</dd>
              </div>
            </dl>
          </div>
          <div class="mt-10 md:mt-0 relative" aria-hidden="true">
            <div class="absolute -inset-6 bg-gradient-to-br from-white/80 via-white/40 to-moss-100/70 rounded-3xl blur-xl"></div>
            <div class="relative glass-panel rounded-3xl px-6 py-8 shadow-soft">
              <h2 class="text-sm font-medium text-slategreen/80 tracking-[0.18em] uppercase">How to æŠ•ç¨¿</h2>
              <ul class="mt-4 space-y-4 text-sm text-sand-700">
                <li class="flex gap-3">
                  <span class="h-9 w-9 flex items-center justify-center rounded-full bg-moss-500/10 text-moss-500 font-semibold">1</span>
                  <span>ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ãŠã™ã™ã‚åº¦ã‚’å…¥åŠ›ã€‚æ—¢å­˜ã®å€™è£œã¯è‡ªå‹•ã§ã‚µã‚¸ã‚§ã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚</span>
                </li>
                <li class="flex gap-3">
                  <span class="h-9 w-9 flex items-center justify-center rounded-full bg-moss-500/10 text-moss-500 font-semibold">2</span>
                  <span>ä»»æ„ã§ãƒªãƒ³ã‚¯ã‚„æ¨ã—ãƒã‚¤ãƒ³ãƒˆã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ·»ãˆã¦ã€ã¿ã‚“ãªã«å±Šã‘ã¾ã—ã‚‡ã†ã€‚</span>
                </li>
                <li class="flex gap-3">
                  <span class="h-9 w-9 flex items-center justify-center rounded-full bg-moss-500/10 text-moss-500 font-semibold">3</span>
                  <span>ä¸€è¦§ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã€‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰è©³ç´°ã‚’é–‹ã„ã¦ã€ã•ã‚‰ã«è©•ä¾¡ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="mb-3 flex justify-end">
        <button
            id="toggle-form"
            class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"
            aria-controls="form-section"
            aria-expanded="false"
        >
            ï¼‹ ã‚ãªãŸã®ã‚ªã‚¹ã‚¹ãƒ¡ã®æœ¬ã‚’ç™»éŒ²ã™ã‚‹
        </button>
        </div>
        <section
        id="form-section"
        class="overflow-hidden transition-[max-height] duration-300 ease-out max-h-0"
        >
            <div class="glass-panel rounded-3xl p-6 sm:p-8 shadow-soft mb-6 md:mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <div>
                <h2 class="text-xl font-semibold text-slategreen">ã‚ãªãŸãŠã™ã™ã‚ã®æœ¬ã‚’ç™»éŒ²</h2>
                <p class="text-sm text-sand-700 mt-1">ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ä¸­ã«ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã€é‡è¤‡ç™»éŒ²ã‚’é˜²ãã¾ã™ã€‚</p>
                </div>
                <span class="tag-chip">ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦</span>
            </div>
            <div class="grid sm:grid-cols-2 gap-4 relative">
                <div class="sm:col-span-2 relative">
                <label class="block text-sm mb-1 text-slategreen/80">æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰</label>
                <input id="inp-title" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="ä¾‹ï¼‰ã‚¦ã‚©ãƒ¼ãƒ«è¡—ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ»ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼" />
                <div id="suggest-box" class="dropdown hidden mt-2"></div>
                </div>

                <div>
                <label class="block text-sm mb-1 text-slategreen/80">ã‚«ãƒ†ã‚´ãƒªï¼ˆå¿…é ˆï¼‰</label>
                <select id="inp-category" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option>æ ªå¼ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</option>
                    <option>ä¸å‹•ç”£</option>
                    <option>FIREé–¢é€£</option>
                    <option>FX</option>
                    <option>ãã®ä»–</option>
                </select>
                </div>

                <div>
                <label class="block text-sm mb-1 text-slategreen/80">ã‚ªã‚¹ã‚¹ãƒ¡åº¦ â˜…ï¼ˆå¿…é ˆï¼‰</label>
                <select id="inp-rating" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="1">â˜…1</option>
                    <option value="2">â˜…2</option>
                    <option value="3">â˜…3</option>
                    <option value="4">â˜…4</option>
                    <option value="5">â˜…5</option>
                </select>
                </div>

                <div>
                <label class="block text-sm mb-1 text-slategreen/80">è‘—è€…ï¼ˆä»»æ„ï¼‰</label>
                <input id="inp-author" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="è‘—è€…å" />
                </div>

                <div>
                <label class="block text-sm mb-1 text-slategreen/80">URLï¼ˆä»»æ„ï¼‰</label>
                <input id="inp-url" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="Amazonç­‰ã®ãƒªãƒ³ã‚¯" />
                </div>

                <div class="sm:col-span-2">
                <label class="block text-sm mb-1 text-slategreen/80">ãŠã™ã™ã‚ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
                <textarea id="inp-reason" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" rows="3" placeholder="ãªãœã‚ªã‚¹ã‚¹ãƒ¡ï¼Ÿ"></textarea>
                </div>

                <div class="sm:col-span-2">
                <label class="block text-sm mb-1 text-slategreen/80">ã‚ãªãŸã®åå‰ï¼ˆä»»æ„ãƒ»è¡¨ç¤ºç”¨ï¼‰</label>
                <input id="inp-name" class="w-full border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¯" />
                </div>

                <div class="sm:col-span-2 flex flex-wrap items-center gap-4 mt-2">
                <button id="btn-submit" class="px-6 py-2.5 rounded-xl bg-slategreen text-white font-medium shadow-lg shadow-slategreen/25 hover:shadow-xl hover:translate-y-[-1px] transition-transform duration-300">ç™»éŒ²ã™ã‚‹</button>
                <span id="form-msg" class="text-sm text-sand-700"></span>
                </div>
            </div>
            <p class="text-xs text-sand-500 mt-4">ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ä¸­ã«ã€Œã™ã§ã«ã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿã€å€™è£œã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            </div>
        </section>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ -->
      <section class="mb-6" data-animate>
        <div class="glass-panel rounded-3xl px-5 py-4 shadow-soft border border-white/50">
          <div class="flex flex-col lg:flex-row gap-4 lg:items-end">
            <div class="flex-1 grid sm:grid-cols-2 md:grid-cols-3 gap-4">
              <label class="flex flex-col gap-2 text-sm text-slategreen/80">
                <span>ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿</span>
                <select id="filter-category" class="border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition">
                  <option value="">ã™ã¹ã¦</option>
                  <option>æ ªå¼ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</option>
                  <option>ä¸å‹•ç”£</option>
                  <option>FIREé–¢é€£</option>
                  <option>FX</option>
                  <option>ãã®ä»–</option>
                </select>
              </label>
              <label class="flex flex-col gap-2 text-sm text-slategreen/80">
                <span>ä¸¦ã³æ›¿ãˆ</span>
                <select id="sort-by" class="border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition">
                  <option value="score">è©•ä¾¡ãŒé«˜ã„é †</option>
                  <option value="new">ç™»éŒ²ãŒæ–°ã—ã„é †</option>
                  <option value="count">æŠ•ç¨¿æ•°ãŒå¤šã„é †</option>
                </select>
              </label>
              <label class="flex flex-col gap-2 text-sm text-slategreen/80">
                <span>ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢</span>
                <input id="search-q" class="border border-white/70 bg-white/70 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" />
              </label>
            </div>
            <div class="lg:w-[240px] flex items-center gap-2 text-xs text-slategreen/70">
              <span class="inline-flex h-2 w-2 rounded-full bg-slategreen/60 animate-pulse"></span>
              <span>é›†è¨ˆãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•æ›´æ–°ä¸­</span>
            </div>
          </div>
        </div>
      </section>

      <!-- ä¸€è¦§ -->
      <section class="glass-panel rounded-3xl shadow-soft border border-white/60" data-animate>
        <div class="flex justify-between items-center px-6 pt-6 pb-3 text-xs text-sand-700">
          <span class="font-medium tracking-[0.16em] uppercase text-slategreen/70">recommended shelf</span>
          <time id="last-update" class="opacity-70"></time>
        </div>
        <div id="list-loader" class="px-6 pb-4 hidden">
          <div class="flex items-center gap-3 text-sand-700 text-sm">
            <div class="flex gap-1">
              <span class="loader-dot"></span>
              <span class="loader-dot"></span>
              <span class="loader-dot"></span>
            </div>
            <span>æœ€æ–°ã®æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</span>
          </div>
        </div>
        <div id="list" class="space-y-3 px-3 pb-7"></div>
        <div id="empty" class="px-6 pb-7 text-center text-slategreen/60 hidden">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </section>
    </div>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="dlg-detail" class="rounded-3xl p-0 w-11/12 max-w-2xl border border-white/60">
    <div class="modal-card rounded-3xl overflow-hidden shadow-soft">
      <div class="p-6 border-b border-sand-200 flex flex-wrap sm:flex-nowrap items-start gap-3">
        <div class="grow">
          <h3 id="detail-title" class="text-xl font-semibold text-slategreen"></h3>
          <div id="detail-meta" class="text-sm text-sand-700 mt-1"></div>
        </div>
        <button onclick="closeDetail()" class="px-4 py-2 rounded-xl bg-sand-100 text-slategreen text-sm font-medium hover:bg-sand-200 transition">é–‰ã˜ã‚‹</button>
      </div>
      <div class="p-6 space-y-6 max-h-[70vh] overflow-auto">
        <div>
          <h4 class="font-semibold text-slategreen mb-2">å¹³å‡ã‚ªã‚¹ã‚¹ãƒ¡åº¦</h4>
          <div id="detail-avg" class="flex items-center gap-2"></div>
        </div>
        <div>
          <h4 class="font-semibold text-slategreen mb-2">ã¿ã‚“ãªã®ãŠã™ã™ã‚ç†ç”±</h4>
          <ul id="detail-reasons" class="space-y-3"></ul>
        </div>
        <div class="text-xs text-sand-600" id="detail-dates"></div>
        <div class="border-t border-sand-200 pt-4">
          <h4 class="font-semibold text-slategreen mb-2">ã“ã®æœ¬ã«è©•ä¾¡ã‚’è¿½åŠ </h4>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1 text-slategreen/80">ã‚ªã‚¹ã‚¹ãƒ¡åº¦ï¼ˆå¿…é ˆï¼‰</label>
              <select id="add-rating" class="w-full border border-sand-200 bg-white rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="1">â˜…1</option>
                <option value="2">â˜…2</option>
                <option value="3">â˜…3</option>
                <option value="4">â˜…4</option>
                <option value="5">â˜…5</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1 text-slategreen/80">ã‚ãªãŸã®åå‰ï¼ˆä»»æ„ï¼‰</label>
              <input id="add-name" class="w-full border border-sand-200 bg-white rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¯" />
            </div>
            <div>
              <label class="block text-sm mb-1 text-slategreen/80">URLï¼ˆä»»æ„ï¼‰</label>
              <input id="add-url" class="w-full border border-sand-200 bg-white rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" placeholder="Amazonç­‰ã®ãƒªãƒ³ã‚¯" />
            </div>
            <div>
              <label class="block text-sm mb-1 text-slategreen/80">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ãƒ»æ—¢å®šã¯æ—¢å­˜ã‚«ãƒ†ã‚´ãƒªï¼‰</label>
              <select id="add-category" class="w-full border border-sand-200 bg-white rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition">
                <option value="">ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰</option>
                <option>æ ªå¼ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</option>
                <option>ä¸å‹•ç”£</option>
                <option>FIREé–¢é€£</option>
                <option>FX</option>
                <option>ãã®ä»–</option>
              </select>
            </div>
            <div class="sm:col-span-2">
              <label class="block text-sm mb-1 text-slategreen/80">ãŠã™ã™ã‚ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
              <textarea id="add-reason" class="w-full border border-sand-200 bg-white rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-moss-400 focus:border-transparent transition" rows="3" placeholder="ãªãœã‚ªã‚¹ã‚¹ãƒ¡ï¼Ÿ"></textarea>
            </div>
            <div class="sm:col-span-2 flex flex-wrap items-center gap-3">
              <button id="add-submit" class="px-5 py-2.5 rounded-xl bg-slategreen text-white font-medium shadow-lg shadow-slategreen/25 hover:shadow-xl hover:translate-y-[-1px] transition-transform duration-300">ã“ã®æœ¬ã«è©•ä¾¡ã‚’è¿½åŠ </button>
              <span id="add-msg" class="text-sm text-sand-700"></span>
            </div>
          </div>
          <input type="hidden" id="current-title" />
          <input type="hidden" id="current-category" />
        </div>
      </div>
    </div>
  </dialog>

<script>
  // ====== ç’°å¢ƒå¤‰æ•°ï¼ˆç½®ãæ›ãˆï¼‰ ======
  const SUPABASE_URL = "https://ssqbcwhophlmhcxyrkjx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzcWJjd2hvcGhsbWhjeHlya2p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0OTg1ODksImV4cCI6MjA3NTA3NDU4OX0.RFsUcX-NczrHI9mgaMNHLqtIlCVp-0uthELS6L1Hq_w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ä¾¿åˆ©é–¢æ•°
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const debounce = (fn, ms=300) => {
    let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  };
  const starNode = (n, filled) => {
    const s=document.createElement('span'); s.textContent='â˜…'; s.className='star'+(filled?' filled':''); return s;
  };
  function renderStars(container, score, max=5) {
    container.innerHTML='';
    for (let i=1; i<=max; i++) container.appendChild(starNode(i, i<=Math.round(score)));
    const t=document.createElement('span'); t.className='text-sm text-sand-700 ml-2'; t.textContent = `(${score})`;
    container.appendChild(t);
  }

  // ====== ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰ ======
  const titleInput = document.getElementById('inp-title');
  const suggestBox = document.getElementById('suggest-box');

  async function fetchSuggests(q) {
    if (!q || q.trim().length < 2) { suggestBox.classList.add('hidden'); suggestBox.innerHTML=''; return; }
    const { data, error } = await supabase.rpc('suggest_similar_titles', { q, limit_count: 8 });
    if (error) { console.warn(error); suggestBox.classList.add('hidden'); return; }

    if (!data || data.length === 0) { suggestBox.classList.add('hidden'); suggestBox.innerHTML=''; return; }

    suggestBox.innerHTML = '<div class="px-4 py-2 text-xs text-sand-600">ã™ã§ã«ã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿ</div>'
      + data.map(d => `<div class="dropdown-item" data-title="${d.title}">${d.title} <span class="text-sand-500">/ ${d.author}</span></div>`).join('');
    suggestBox.classList.remove('hidden');
  }
  titleInput.addEventListener('input', debounce(e => fetchSuggests(e.target.value), 250));
  suggestBox.addEventListener('click', (e) => {
    const item = e.target.closest('.dropdown-item');
    if (!item) return;
    titleInput.value = item.dataset.title;
    suggestBox.classList.add('hidden');
  });
  document.addEventListener('click', (e) => {
    if (!suggestBox.contains(e.target) && e.target !== titleInput) suggestBox.classList.add('hidden');
  });

  // ====== ç™»éŒ² ======
  const msg = document.getElementById('form-msg');
  document.getElementById('btn-submit').addEventListener('click', async () => {
    msg.textContent = '';
    const title = document.getElementById('inp-title').value.trim();
    const category = document.getElementById('inp-category').value;
    const rating = Number(document.getElementById('inp-rating').value);
    const author_raw = document.getElementById('inp-author').value.trim();
    const url = document.getElementById('inp-url').value.trim();
    const reason_raw = document.getElementById('inp-reason').value.trim();
    const name = document.getElementById('inp-name').value.trim();
    const date_str = new Date().toISOString().slice(0,10);

    if (!title || !category || !rating) {
      msg.textContent = 'å¿…é ˆé …ç›®ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚«ãƒ†ã‚´ãƒªï¼â˜…ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      msg.className = 'text-sm text-red-600';
      return;
    }

    // è¿‘ä¼¼ã‚¿ã‚¤ãƒˆãƒ«ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€è»½ãæ³¨æ„å–šèµ·
    const { data: sugg } = await supabase.rpc('suggest_similar_titles', { q: title, limit_count: 1 });
    if (sugg && sugg.length) {
      const s = sugg[0];
      if (s.levenshtein_dist <= 3 || s.similarity_score >= 0.35) {
        if (!confirm(`ã€Œ${s.title}ã€ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      }
    }

    const { error } = await supabase.from('recommendations').insert([{
      title, category, rating, author_raw, url, reason_raw, name, date_str
    }]);
    if (error) {
      console.error(error);
      msg.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      msg.className = 'text-sm text-red-600';
    } else {
      msg.textContent = 'ç™»éŒ²ã—ã¾ã—ãŸï¼ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã™â€¦';
      msg.className = 'text-sm text-moss-500';
      await sleep(300);
      resetForm();
      await loadList();  // å†èª­è¾¼
      // æŠ˜ã‚Šç•³ã¿ã‚’é–‰ã˜ã¦ä¸€è¦§ã¸
      if (typeof setOpen === 'function') {
         setOpen(false);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  function resetForm() {
    ['inp-title','inp-category','inp-rating','inp-author','inp-url','inp-reason','inp-name'].forEach(id=>{
      const el=document.getElementById(id);
      if (el.tagName==='SELECT') el.value='';
      else el.value='';
    });
  }

  // ====== ä¸€è¦§ã®èª­ã¿è¾¼ã¿ ======
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const loaderEl = document.getElementById('list-loader');
  const lastUpdateEl = document.getElementById('last-update');

  async function loadList() {
    loaderEl.classList.remove('hidden');
    listEl.classList.add('opacity-60');
    const filterCat = document.getElementById('filter-category').value;
    const sortBy = document.getElementById('sort-by').value;
    const q = document.getElementById('search-q').value.trim();

    let qb = supabase.from('book_stats').select('*');

    if (filterCat) qb = qb.eq('category', filterCat);
    if (q) qb = qb.ilike('title', `%${q}%`);

    // ä¸¦ã³æ›¿ãˆ
    if (sortBy === 'score') qb = qb.order('avg_rating', { ascending: false }).order('posts_count', { ascending: false });
    if (sortBy === 'count') qb = qb.order('posts_count', { ascending: false }).order('avg_rating', { ascending: false });
    if (sortBy === 'new')   qb = qb.order('last_post_at', { ascending: false });

    const { data, error } = await qb;
    loaderEl.classList.add('hidden');
    listEl.classList.remove('opacity-60');

    if (error) { console.error(error); listEl.innerHTML=''; emptyEl.classList.remove('hidden'); return; }

    if (!data || data.length===0) { listEl.innerHTML=''; emptyEl.classList.remove('hidden'); return; }
    emptyEl.classList.add('hidden');

    listEl.innerHTML = data.map(b => {
      const avgRounded = Math.round(b.avg_rating);
      const dateStr = b.last_post_at ? new Date(b.last_post_at).toLocaleDateString() : '-';
      const author = b.author || 'ä¸æ˜';
      return `
      <article class="relative list-card rounded-2xl bg-white/82 px-6 py-5 overflow-hidden" data-title_key="${b.title_key}">
        <div class="flex flex-col lg:flex-row lg:items-start gap-4 lg:gap-8">
          <div class="flex-1 space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <h3 class="text-lg font-semibold text-slategreen">${escapeHtml(b.title)}</h3>
              <span class="badge">${escapeHtml(b.category || 'ãã®ä»–')}</span>
            </div>
            <p class="text-sm text-sand-700">è‘—è€…ï¼š${escapeHtml(author)}</p>
            <div class="flex flex-wrap items-center gap-3 text-sm text-sand-700">
              <div class="flex items-center gap-1">
                ${['','','','',''].map((_,i)=>`<span class=\"star ${i<avgRounded?'filled':''}\">â˜…</span>`).join('')}
              </div>
              <span>å¹³å‡${b.avg_rating}</span>
              <span class="inline-flex items-center gap-1 text-xs text-slategreen/70 px-2 py-1 rounded-full bg-moss-500/10">æŠ•ç¨¿ ${b.posts_count}</span>
            </div>
          </div>
          <div class="text-xs text-sand-600 lg:text-right lg:min-w-[120px]">æœ€çµ‚æ›´æ–°: ${dateStr}</div>
        </div>
      </article>`;
    }).join('');

    const newest = data[0]?.last_post_at;
    if (newest) {
      const dt = new Date(newest);
      lastUpdateEl.textContent = `æœ€çµ‚æ›´æ–°: ${dt.toLocaleDateString()}`;
    } else {
      lastUpdateEl.textContent = '';
    }

    revealOnScroll();
  }

  listEl.addEventListener('click', async (e) => {
    const row = e.target.closest('[data-title_key]');
    if (!row) return;
    const key = row.getAttribute('data-title_key');
    await openDetail(key);
  });

  // ====== è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ======
  async function openDetail(title_key) {
    let { data: books } = await supabase.from('book_stats').select('*').eq('title_key', title_key).limit(1);
    const b = books && books[0];
    if (!b) return;

    document.getElementById('detail-title').textContent = b.title;
    document.getElementById('detail-meta').textContent = `è‘—è€…ï¼š${b.author} ï¼ ã‚«ãƒ†ã‚´ãƒªï¼š${b.category || 'ãã®ä»–'}`;

    const avgWrap = document.getElementById('detail-avg');
    renderStars(avgWrap, b.avg_rating);

    const { data: recs } = await supabase
      .from('recommendations')
      .select('rating, reason_raw, name, url, date_str')
      .ilike('title', b.title);

    const ul = document.getElementById('detail-reasons');
    ul.innerHTML = (recs||[]).map(r => {
      const link = r.url ? `<a class="text-moss-500 underline underline-offset-4" href="${escapeAttr(r.url)}" target="_blank" rel="noopener">ãƒªãƒ³ã‚¯</a>` : '';
      const who = r.name ? `ï¼ˆby ${escapeHtml(r.name)}ï¼‰` : '';
      return `<li class="p-4 rounded-2xl border border-sand-200 bg-white/90">
        <div class="mb-1">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
        <div class="text-sm text-slategreen whitespace-pre-wrap">${escapeHtml(r.reason_raw || 'ï¼ˆç†ç”±ãªã—ï¼‰')}</div>
        <div class="mt-2 text-xs text-sand-600 flex flex-wrap items-center gap-3">
          <span>${escapeHtml(r.date_str || '')}</span>
          ${link}
          <span>${who}</span>
        </div>
      </li>`;
    }).join('');

    const first = b.first_post_at ? new Date(b.first_post_at).toLocaleDateString() : '-';
    const last  = b.last_post_at ? new Date(b.last_post_at).toLocaleDateString() : '-';
    document.getElementById('detail-dates').textContent = `ç™»éŒ²æ—¥: ${first} ï¼ æœ€çµ‚æ›´æ–°æ—¥: ${last}`;
    document.getElementById('current-title').value = b.title;
    document.getElementById('current-category').value = b.category || '';
    const addCatSel = document.getElementById('add-category');
    if (addCatSel) addCatSel.value = '';

    document.getElementById('dlg-detail').showModal();
  }
  function closeDetail(){ document.getElementById('dlg-detail').close(); }

  // ====== ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆãƒ»æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ ======
  document.getElementById('filter-category').addEventListener('change', loadList);
  document.getElementById('sort-by').addEventListener('change', loadList);
  document.getElementById('search-q').addEventListener('input', debounce(loadList, 250));

  document.getElementById('add-submit').addEventListener('click', async () => {
    const msgEl = document.getElementById('add-msg');
    msgEl.textContent = '';
    msgEl.className = 'text-sm text-sand-700';

    const title = document.getElementById('current-title').value;
    const currentCat = document.getElementById('current-category').value;
    const rating = Number(document.getElementById('add-rating').value);
    const name = document.getElementById('add-name').value.trim();
    const url = document.getElementById('add-url').value.trim();
    const reason_raw = document.getElementById('add-reason').value.trim();
    const pickedCat = document.getElementById('add-category').value;
    const category = pickedCat || currentCat || 'ãã®ä»–';
    const date_str = new Date().toISOString().slice(0,10);

    if (!title || !rating) {
      msgEl.textContent = 'å¿…é ˆé …ç›®ï¼ˆâ˜…ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      msgEl.className = 'text-sm text-red-600';
      return;
    }

    const { error } = await supabase.from('recommendations').insert([{
      title,
      category,
      rating,
      reason_raw,
      url,
      name,
      date_str
    }]);

    if (error) {
      console.error(error);
      msgEl.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      msgEl.className = 'text-sm text-red-600';
      return;
    }

    msgEl.textContent = 'ç™»éŒ²ã—ã¾ã—ãŸï¼ä¸€è¦§ã¨è©³ç´°ã‚’æ›´æ–°ã—ã¾ã™â€¦';
    msgEl.className = 'text-sm text-moss-500';

    document.getElementById('add-rating').value = '';
    document.getElementById('add-name').value = '';
    document.getElementById('add-url').value = '';
    document.getElementById('add-reason').value = '';
    document.getElementById('add-category').value = '';

    await loadList();
    await openDetail((title || '').trim().toLowerCase());
  });

  // ====== åˆå›ãƒ­ãƒ¼ãƒ‰ ======
  loadList();

  // ====== XSSç”¨ã®ç°¡æ˜“ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ======
  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
  function escapeAttr(s){ return (s??'').toString().replace(/"/g,'&quot;'); }

  // ====== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ======
  let observerInstance;
  function revealOnScroll(){
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.querySelectorAll('[data-animate]').forEach(el => el.classList.add('is-visible'));
      return;
    }
    if (!observerInstance) {
      observerInstance = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observerInstance.unobserve(entry.target);
          }
        });
      }, { threshold: 0.18, rootMargin: '0px 0px -40px 0px' });
    }
    document.querySelectorAll('[data-animate]').forEach(el => {
      if (!el.classList.contains('is-visible')) observerInstance.observe(el);
    });
  }
  revealOnScroll();
  // ====== ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ ======
    const formSection = document.getElementById('form-section');
    const toggleBtn   = document.getElementById('toggle-form');

    // max-height ã‚’å‹•çš„ã«å½“ã¦ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«é–‹é–‰
    function setMaxHeight(open) {
    if (open) {
        formSection.classList.remove('max-h-0');
        formSection.style.maxHeight = formSection.scrollHeight + 'px';
    } else {
        formSection.style.maxHeight = formSection.scrollHeight + 'px'; // ç›´å‰é«˜ã•ã‚’ä¸€æ—¦ã‚»ãƒƒãƒˆ
        // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§0ã«ã™ã‚‹ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        requestAnimationFrame(() => {
        formSection.classList.add('max-h-0');
        formSection.style.maxHeight = '0px';
        });
    }
    }

    // é–‹ã/é–‰ã˜ã‚‹æœ¬ä½“
    function setOpen(open, {focus=false} = {}) {
    toggleBtn.setAttribute('aria-expanded', String(open));
    setMaxHeight(open);
    localStorage.setItem(STORAGE_KEY, open ? '1' : '0');
    if (open && focus) {
        // åˆå›é–‹ã„ãŸã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        const t = document.getElementById('inp-title');
        if (t) t.focus();
    }
    }

    // ãƒˆã‚°ãƒ«
    toggleBtn.addEventListener('click', () => {
    const nowOpen = toggleBtn.getAttribute('aria-expanded') === 'true';
    setOpen(!nowOpen, {focus: !nowOpen});
    });

    // åˆæœŸçŠ¶æ…‹ï¼šURLã‚¯ã‚¨ãƒª/ãƒãƒƒã‚·ãƒ¥ or ä¿å­˜çŠ¶æ…‹ã§æ±ºå®š
    (function initAccordion(){
    let shouldOpen = false;

    // 1) URL ã§å¼·åˆ¶è¡¨ç¤ºï¼ˆä¾‹: ?add=1 ã‚‚ã—ãã¯ #addï¼‰
    const params = new URLSearchParams(location.search);
    if (params.get('add') === '1' || location.hash === '#add') {
        shouldOpen = true;
    } else {
        // 2) ä¿å­˜ã—ãŸçŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‰ï¼‰
        shouldOpen = localStorage.getItem(STORAGE_KEY) === '1';
    }

    // 3) åˆæœŸã‚»ãƒƒãƒˆï¼ˆã‚¢ãƒ‹ãƒ¡ãªã—ã§ç¢ºå®š â†’ æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã§max-heightåæ˜ ï¼‰
    formSection.style.transition = 'none';
    setOpen(shouldOpen);
    requestAnimationFrame(() => {
        formSection.style.transition = ''; // ã‚¢ãƒ‹ãƒ¡å¾©å¸°
        // é–‹ã„ã¦ã„ã‚‹å ´åˆã€é«˜ã•ã‚’å†è¨ˆç®—ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§ä¸­èº«é«˜ã•ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ï¼‰
        if (shouldOpen) setMaxHeight(true);
    });
    })();

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºã§max-heightå†è¨ˆç®—ï¼ˆé–‹ã„ã¦ã„ã‚‹ã¨ãã ã‘ï¼‰
    window.addEventListener('resize', () => {
    if (toggleBtn.getAttribute('aria-expanded') === 'true') {
        formSection.style.maxHeight = formSection.scrollHeight + 'px';
    }
    });

    // Escã§é–‰ã˜ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ä¸­ã§ã‚‚ç´ æ—©ãé–‰ã˜ãŸã„äººå‘ã‘ï¼‰
    document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && toggleBtn.getAttribute('aria-expanded') === 'true') {
        setOpen(false);
    }
    });

</script>
</body>
</html>
