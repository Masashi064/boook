<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ã¿ã‚“ãªã®æœ¬ç´¹ä»‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .star { font-size: 18px; line-height: 1; }
    .star.filled { color: #f59e0b; } /* amber-500 */
    .badge { padding: 2px 8px; border-radius: 9999px; background: #e5e7eb; font-size: 12px; }
    .dropdown { position: absolute; z-index: 20; background: white; border: 1px solid #e5e7eb; border-radius: 8px; width: 100%; max-height: 240px; overflow: auto; }
    .dropdown-item { padding: 8px 10px; cursor: pointer; }
    .dropdown-item:hover { background: #f3f4f6; }
    dialog::backdrop { background: rgba(0,0,0,.4); }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">ğŸ“š ã¿ã‚“ãªã®æœ¬ç´¹ä»‹ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h1>
      <p class="text-sm text-gray-600">ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§ç™»éŒ²ãƒ»é–²è¦§ã§ãã¾ã™</p>
    </header>

    <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <section class="mb-8 bg-white rounded-xl shadow p-4 sm:p-6">
      <h2 class="font-semibold mb-3">1. ãŠã™ã™ã‚ã®æœ¬ã‚’ç™»éŒ²</h2>
      <div class="grid sm:grid-cols-2 gap-4 relative">
        <div class="sm:col-span-2 relative">
          <label class="block text-sm mb-1">æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰</label>
          <input id="inp-title" class="w-full border rounded-lg p-2" placeholder="ä¾‹ï¼‰ã‚¦ã‚©ãƒ¼ãƒ«è¡—ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ»ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼" />
          <div id="suggest-box" class="dropdown hidden mt-1"></div>
        </div>

        <div>
          <label class="block text-sm mb-1">ã‚«ãƒ†ã‚´ãƒªï¼ˆå¿…é ˆï¼‰</label>
          <select id="inp-category" class="w-full border rounded-lg p-2">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option>æ ªå¼ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</option>
            <option>ä¸å‹•ç”£</option>
            <option>FIREé–¢é€£</option>
            <option>FX</option>
            <option>ãã®ä»–</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">ã‚ªã‚¹ã‚¹ãƒ¡åº¦ â˜…ï¼ˆå¿…é ˆï¼‰</label>
          <select id="inp-rating" class="w-full border rounded-lg p-2">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="1">â˜…1</option>
            <option value="2">â˜…2</option>
            <option value="3">â˜…3</option>
            <option value="4">â˜…4</option>
            <option value="5">â˜…5</option>
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1">è‘—è€…ï¼ˆä»»æ„ï¼‰</label>
          <input id="inp-author" class="w-full border rounded-lg p-2" placeholder="è‘—è€…å" />
        </div>

        <div>
          <label class="block text-sm mb-1">URLï¼ˆä»»æ„ï¼‰</label>
          <input id="inp-url" class="w-full border rounded-lg p-2" placeholder="Amazonç­‰ã®ãƒªãƒ³ã‚¯" />
        </div>

        <div class="sm:col-span-2">
          <label class="block text-sm mb-1">ãŠã™ã™ã‚ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="inp-reason" class="w-full border rounded-lg p-2" rows="3" placeholder="ãªãœã‚ªã‚¹ã‚¹ãƒ¡ï¼Ÿ"></textarea>
        </div>

        <div class="sm:col-span-2">
          <label class="block text-sm mb-1">ã‚ãªãŸã®åå‰ï¼ˆä»»æ„ãƒ»è¡¨ç¤ºç”¨ï¼‰</label>
          <input id="inp-name" class="w-full border rounded-lg p-2" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¯" />
        </div>

        <div class="sm:col-span-2">
          <button id="btn-submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ç™»éŒ²ã™ã‚‹</button>
          <span id="form-msg" class="ml-3 text-sm text-gray-600"></span>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-2">â€» ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ä¸­ã«ã€Œã™ã§ã«ã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿã€å€™è£œã‚’è¡¨ç¤ºã—ã¾ã™</p>
    </section>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆ -->
    <section class="mb-4 flex flex-col sm:flex-row gap-3 sm:items-end">
      <div>
        <label class="block text-sm mb-1">ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿</label>
        <select id="filter-category" class="border rounded-lg p-2">
          <option value="">ã™ã¹ã¦</option>
          <option>æ ªå¼ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</option>
          <option>ä¸å‹•ç”£</option>
          <option>FIREé–¢é€£</option>
          <option>FX</option>
          <option>ãã®ä»–</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">ä¸¦ã³æ›¿ãˆ</label>
        <select id="sort-by" class="border rounded-lg p-2">
          <option value="score">è©•ä¾¡ãŒé«˜ã„é †</option>
          <option value="new">ç™»éŒ²ãŒæ–°ã—ã„é †</option>
          <option value="count">æŠ•ç¨¿æ•°ãŒå¤šã„é †</option>
        </select>
      </div>
      <div class="sm:ml-auto">
        <label class="block text-sm mb-1">ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢</label>
        <input id="search-q" class="border rounded-lg p-2" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" />
      </div>
    </section>

    <!-- ä¸€è¦§ -->
    <section class="bg-white rounded-xl shadow">
      <div id="list" class="divide-y"></div>
      <div id="empty" class="p-6 text-center text-gray-500 hidden">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </section>
  </div>

  <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="dlg-detail" class="rounded-xl p-0 w-11/12 max-w-2xl">
    <div class="p-5 border-b flex items-start gap-3">
      <div class="grow">
        <h3 id="detail-title" class="text-lg font-semibold"></h3>
        <div id="detail-meta" class="text-sm text-gray-600"></div>
      </div>
      <button onclick="closeDetail()" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">é–‰ã˜ã‚‹</button>
    </div>
    <div class="p-5 space-y-4 max-h-[70vh] overflow-auto">
      <div>
        <h4 class="font-semibold mb-2">å¹³å‡ã‚ªã‚¹ã‚¹ãƒ¡åº¦</h4>
        <div id="detail-avg" class="flex items-center gap-2"></div>
      </div>
      <div>
        <h4 class="font-semibold mb-2">ã¿ã‚“ãªã®ãŠã™ã™ã‚ç†ç”±</h4>
        <ul id="detail-reasons" class="space-y-3"></ul>
      </div>
      <div class="text-xs text-gray-500" id="detail-dates"></div>
            <!-- è¿½åŠ : ã“ã®æœ¬ã«è©•ä¾¡ã‚’è¶³ã™ -->
      <div class="border-t pt-4">
        <h4 class="font-semibold mb-2">ã“ã®æœ¬ã«è©•ä¾¡ã‚’è¿½åŠ </h4>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">ã‚ªã‚¹ã‚¹ãƒ¡åº¦ï¼ˆå¿…é ˆï¼‰</label>
            <select id="add-rating" class="w-full border rounded-lg p-2">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="1">â˜…1</option>
              <option value="2">â˜…2</option>
              <option value="3">â˜…3</option>
              <option value="4">â˜…4</option>
              <option value="5">â˜…5</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">ã‚ãªãŸã®åå‰ï¼ˆä»»æ„ï¼‰</label>
            <input id="add-name" class="w-full border rounded-lg p-2" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¯" />
          </div>
          <div>
            <label class="block text-sm mb-1">URLï¼ˆä»»æ„ï¼‰</label>
            <input id="add-url" class="w-full border rounded-lg p-2" placeholder="Amazonç­‰ã®ãƒªãƒ³ã‚¯" />
          </div>
          <div>
            <label class="block text-sm mb-1">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ãƒ»æ—¢å®šã¯æ—¢å­˜ã‚«ãƒ†ã‚´ãƒªï¼‰</label>
            <select id="add-category" class="w-full border rounded-lg p-2">
              <option value="">ï¼ˆå¤‰æ›´ã—ãªã„ï¼‰</option>
              <option>æ ªå¼ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</option>
              <option>ä¸å‹•ç”£</option>
              <option>FIREé–¢é€£</option>
              <option>FX</option>
              <option>ãã®ä»–</option>
            </select>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm mb-1">ãŠã™ã™ã‚ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="add-reason" class="w-full border rounded-lg p-2" rows="3" placeholder="ãªãœã‚ªã‚¹ã‚¹ãƒ¡ï¼Ÿ"></textarea>
          </div>
          <div class="sm:col-span-2">
            <button id="add-submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ã“ã®æœ¬ã«è©•ä¾¡ã‚’è¿½åŠ </button>
            <span id="add-msg" class="ml-2 text-sm text-gray-600"></span>
          </div>
        </div>
        <!-- éš ã—: ç¾åœ¨ã®æœ¬ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¿æŒ -->
        <input type="hidden" id="current-title" />
        <input type="hidden" id="current-category" />
      </div>
    </div>
  </dialog>

<script>
  // ====== ç’°å¢ƒå¤‰æ•°ï¼ˆç½®ãæ›ãˆï¼‰ ======
  const SUPABASE_URL = "https://ssqbcwhophlmhcxyrkjx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzcWJjd2hvcGhsbWhjeHlya2p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0OTg1ODksImV4cCI6MjA3NTA3NDU4OX0.RFsUcX-NczrHI9mgaMNHLqtIlCVp-0uthELS6L1Hq_w"
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ä¾¿åˆ©é–¢æ•°
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const debounce = (fn, ms=300) => {
    let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  };
  const starNode = (n, filled) => {
    const s=document.createElement('span'); s.textContent='â˜…'; s.className='star'+(filled?' filled':''); return s;
  };
  function renderStars(container, score, max=5) {
    container.innerHTML='';
    for (let i=1; i<=max; i++) container.appendChild(starNode(i, i<=Math.round(score)));
    const t=document.createElement('span'); t.className='text-sm text-gray-600 ml-2'; t.textContent = `(${score})`;
    container.appendChild(t);
  }

  // ====== ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰ ======
  const titleInput = document.getElementById('inp-title');
  const suggestBox = document.getElementById('suggest-box');

  async function fetchSuggests(q) {
    if (!q || q.trim().length < 2) { suggestBox.classList.add('hidden'); suggestBox.innerHTML=''; return; }
    const { data, error } = await supabase.rpc('suggest_similar_titles', { q, limit_count: 8 });
    if (error) { console.warn(error); suggestBox.classList.add('hidden'); return; }

    if (!data || data.length === 0) { suggestBox.classList.add('hidden'); suggestBox.innerHTML=''; return; }

    suggestBox.innerHTML = '<div class="px-3 py-2 text-xs text-gray-500">ã™ã§ã«ã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿ</div>'
      + data.map(d => `<div class="dropdown-item" data-title="${d.title}">${d.title} <span class="text-gray-500">/ ${d.author}</span></div>`).join('');
    suggestBox.classList.remove('hidden');
  }
  titleInput.addEventListener('input', debounce(e => fetchSuggests(e.target.value), 250));
  suggestBox.addEventListener('click', (e) => {
    const item = e.target.closest('.dropdown-item');
    if (!item) return;
    titleInput.value = item.dataset.title;
    suggestBox.classList.add('hidden');
  });
  document.addEventListener('click', (e) => {
    if (!suggestBox.contains(e.target) && e.target !== titleInput) suggestBox.classList.add('hidden');
  });

  // ====== ç™»éŒ² ======
  const msg = document.getElementById('form-msg');
  document.getElementById('btn-submit').addEventListener('click', async () => {
    msg.textContent = '';
    const title = document.getElementById('inp-title').value.trim();
    const category = document.getElementById('inp-category').value;
    const rating = Number(document.getElementById('inp-rating').value);
    const author_raw = document.getElementById('inp-author').value.trim();
    const url = document.getElementById('inp-url').value.trim();
    const reason_raw = document.getElementById('inp-reason').value.trim();
    const name = document.getElementById('inp-name').value.trim();
    const date_str = new Date().toISOString().slice(0,10);

    if (!title || !category || !rating) {
      msg.textContent = 'å¿…é ˆé …ç›®ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚«ãƒ†ã‚´ãƒªï¼â˜…ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      msg.className = 'ml-3 text-sm text-red-600';
      return;
    }

    // è¿‘ä¼¼ã‚¿ã‚¤ãƒˆãƒ«ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€è»½ãæ³¨æ„å–šèµ·
    const { data: sugg } = await supabase.rpc('suggest_similar_titles', { q: title, limit_count: 1 });
    if (sugg && sugg.length) {
      const s = sugg[0];
      if (s.levenshtein_dist <= 3 || s.similarity_score >= 0.35) {
        if (!confirm(`ã€Œ${s.title}ã€ãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      }
    }

    const { error } = await supabase.from('recommendations').insert([{
      title, category, rating, author_raw, url, reason_raw, name, date_str
    }]);
    if (error) {
      console.error(error);
      msg.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
      msg.className = 'ml-3 text-sm text-red-600';
    } else {
      msg.textContent = 'ç™»éŒ²ã—ã¾ã—ãŸï¼ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã™â€¦';
      msg.className = 'ml-3 text-sm text-green-700';
      await sleep(500);
      resetForm();
      await loadList();  // å†èª­è¾¼
    }
  });

  function resetForm() {
    ['inp-title','inp-category','inp-rating','inp-author','inp-url','inp-reason','inp-name'].forEach(id=>{
      const el=document.getElementById(id);
      if (el.tagName==='SELECT') el.value='';
      else el.value='';
    });
  }

  // ====== ä¸€è¦§ã®èª­ã¿è¾¼ã¿ ======
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');

  async function loadList() {
    const filterCat = document.getElementById('filter-category').value;
    const sortBy = document.getElementById('sort-by').value;
    const q = document.getElementById('search-q').value.trim();

    let qb = supabase.from('book_stats').select('*');

    if (filterCat) qb = qb.eq('category', filterCat);
    if (q) qb = qb.ilike('title', `%${q}%`);

    // ä¸¦ã³æ›¿ãˆ
    if (sortBy === 'score') qb = qb.order('avg_rating', { ascending: false }).order('posts_count', { ascending: false });
    if (sortBy === 'count') qb = qb.order('posts_count', { ascending: false }).order('avg_rating', { ascending: false });
    if (sortBy === 'new')   qb = qb.order('last_post_at', { ascending: false });

    const { data, error } = await qb;
    if (error) { console.error(error); listEl.innerHTML=''; emptyEl.classList.remove('hidden'); return; }

    if (!data || data.length===0) { listEl.innerHTML=''; emptyEl.classList.remove('hidden'); return; }
    emptyEl.classList.add('hidden');

    listEl.innerHTML = data.map(b => {
      const stars = 'â˜…'.repeat(Math.round(b.avg_rating)) + 'â˜†'.repeat(5 - Math.round(b.avg_rating));
      const dateStr = b.last_post_at ? new Date(b.last_post_at).toLocaleDateString() : '-';
      return `
      <div class="p-4 hover:bg-gray-50 cursor-pointer" data-title_key="${b.title_key}">
        <div class="flex items-start gap-3">
          <div class="grow">
            <div class="text-base font-semibold">${escapeHtml(b.title)}</div>
            <div class="text-sm text-gray-600">è‘—è€…ï¼š${escapeHtml(b.author || 'ä¸æ˜')}</div>
            <div class="mt-1 flex items-center gap-2">
              <span class="star ${Math.round(b.avg_rating)>=1?'filled':''}">â˜…</span>
              <span class="star ${Math.round(b.avg_rating)>=2?'filled':''}">â˜…</span>
              <span class="star ${Math.round(b.avg_rating)>=3?'filled':''}">â˜…</span>
              <span class="star ${Math.round(b.avg_rating)>=4?'filled':''}">â˜…</span>
              <span class="star ${Math.round(b.avg_rating)>=5?'filled':''}">â˜…</span>
              <span class="text-sm text-gray-600">å¹³å‡${b.avg_rating} / æŠ•ç¨¿ ${b.posts_count}</span>
              <span class="badge">${escapeHtml(b.category || 'ãã®ä»–')}</span>
            </div>
          </div>
          <div class="text-xs text-gray-500 whitespace-nowrap">æœ€çµ‚æ›´æ–°: ${dateStr}</div>
        </div>
      </div>`;
    }).join('');
  }

  listEl.addEventListener('click', async (e) => {
    const row = e.target.closest('[data-title_key]');
    if (!row) return;
    const key = row.getAttribute('data-title_key');
    await openDetail(key);
  });

  // ====== è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ======
  async function openDetail(title_key) {
    // ä»£è¡¨æƒ…å ±
    let { data: books } = await supabase.from('book_stats').select('*').eq('title_key', title_key).limit(1);
    const b = books && books[0];
    if (!b) return;

    document.getElementById('detail-title').textContent = b.title;
    document.getElementById('detail-meta').textContent = `è‘—è€…ï¼š${b.author} ï¼ ã‚«ãƒ†ã‚´ãƒªï¼š${b.category || 'ãã®ä»–'}`;

    const avgWrap = document.getElementById('detail-avg');
    renderStars(avgWrap, b.avg_rating);

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ï¼ˆå…ƒãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
    const { data: recs } = await supabase
      .from('recommendations')
      .select('rating, reason_raw, name, url, date_str')
      .ilike('title', b.title); // å¤§æ–‡å­—å°æ–‡å­—ã‚’æ°—ã«ã›ãšåŒåã‚’æ‹¾ã†

    const ul = document.getElementById('detail-reasons');
    ul.innerHTML = (recs||[]).map(r => {
      const link = r.url ? `<a class="text-blue-600 underline" href="${escapeAttr(r.url)}" target="_blank" rel="noopener">ãƒªãƒ³ã‚¯</a>` : '';
      const who = r.name ? `ï¼ˆby ${escapeHtml(r.name)}ï¼‰` : '';
      return `<li class="p-3 rounded-lg border">
        <div class="mb-1">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
        <div class="text-sm whitespace-pre-wrap">${escapeHtml(r.reason_raw || 'ï¼ˆç†ç”±ãªã—ï¼‰')}</div>
        <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
          <span>${escapeHtml(r.date_str || '')}</span>
          ${link}
          <span>${who}</span>
        </div>
      </li>`;
    }).join('');

    const first = b.first_post_at ? new Date(b.first_post_at).toLocaleDateString() : '-';
    const last  = b.last_post_at ? new Date(b.last_post_at).toLocaleDateString() : '-';
    document.getElementById('detail-dates').textContent = `ç™»éŒ²æ—¥: ${first} ï¼ æœ€çµ‚æ›´æ–°æ—¥: ${last}`;
        // ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«/ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    document.getElementById('current-title').value = b.title;
    document.getElementById('current-category').value = b.category || '';
    // æ—¢å®šã‚«ãƒ†ã‚´ãƒªï¼ˆå¤‰æ›´ã—ãªã„å ´åˆã¯ç©ºã®ã¾ã¾ï¼‰
    const addCatSel = document.getElementById('add-category');
    if (addCatSel) addCatSel.value = '';


    document.getElementById('dlg-detail').showModal();
  }
  function closeDetail(){ document.getElementById('dlg-detail').close(); }

  // ====== ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆãƒ»æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ ======
  document.getElementById('filter-category').addEventListener('change', loadList);
  document.getElementById('sort-by').addEventListener('change', loadList);
  document.getElementById('search-q').addEventListener('input', debounce(loadList, 250));
  // è©³ç´°ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è©•ä¾¡ã‚’è¿½åŠ 
document.getElementById('add-submit').addEventListener('click', async () => {
  const msgEl = document.getElementById('add-msg');
  msgEl.textContent = '';
  msgEl.className = 'ml-2 text-sm text-gray-600';

  const title = document.getElementById('current-title').value;         // å¿…é ˆï¼ˆå›ºå®šï¼‰
  const currentCat = document.getElementById('current-category').value; // ä»£è¡¨ã‚«ãƒ†ã‚´ãƒª
  const rating = Number(document.getElementById('add-rating').value);
  const name = document.getElementById('add-name').value.trim();
  const url = document.getElementById('add-url').value.trim();
  const reason_raw = document.getElementById('add-reason').value.trim();
  const pickedCat = document.getElementById('add-category').value;
  const category = pickedCat || currentCat || 'ãã®ä»–';
  const date_str = new Date().toISOString().slice(0,10);

  if (!title || !rating) {
    msgEl.textContent = 'å¿…é ˆé …ç›®ï¼ˆâ˜…ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    msgEl.className = 'ml-2 text-sm text-red-600';
    return;
  }

  const { error } = await supabase.from('recommendations').insert([{
    title,
    category,
    rating,
    reason_raw,
    url,
    name,
    date_str
  }]);

  if (error) {
    console.error(error);
    msgEl.textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    msgEl.className = 'ml-2 text-sm text-red-600';
    return;
  }

  msgEl.textContent = 'ç™»éŒ²ã—ã¾ã—ãŸï¼ä¸€è¦§ã¨è©³ç´°ã‚’æ›´æ–°ã—ã¾ã™â€¦';
  msgEl.className = 'ml-2 text-sm text-green-700';

  // å…¥åŠ›å€¤ã‚’è»½ãã‚¯ãƒªã‚¢
  document.getElementById('add-rating').value = '';
  document.getElementById('add-name').value = '';
  document.getElementById('add-url').value = '';
  document.getElementById('add-reason').value = '';
  document.getElementById('add-category').value = '';

  // ä¸€è¦§ã¨è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆå¹³å‡ã‚„ä»¶æ•°ã‚’å³åæ˜ ï¼‰
  await loadList();
  await openDetail((title || '').trim().toLowerCase()); // title_keyã«ç›¸å½“ã™ã‚‹ã‚­ãƒ¼ã§å†è¡¨ç¤º
});


  // ====== åˆå›ãƒ­ãƒ¼ãƒ‰ ======
  loadList();

  // ====== XSSç”¨ã®ç°¡æ˜“ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ======
  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
  function escapeAttr(s){ return (s??'').toString().replace(/"/g,'&quot;'); }
</script>
</body>
</html>
